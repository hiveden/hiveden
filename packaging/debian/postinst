#!/bin/bash

# Create hiveden user if not exists
if ! id -u hiveden >/dev/null 2>&1; then
    useradd -r -s /usr/sbin/nologin -d /opt/hiveden -c "Hiveden Service User" hiveden
fi

# Ensure application directory exists
mkdir -p /opt/hiveden

# Set ownership of application directory
chown -R hiveden:hiveden /opt/hiveden
chmod 750 /opt/hiveden

# Install all Python dependencies via pip
# Use --break-system-packages as we are intentionally installing into the system environment for this appliance
if command -v pip3 >/dev/null 2>&1; then
    pip3 install --break-system-packages --no-warn-script-location click fastapi uvicorn docker PyYAML psutil lxc paramiko websockets pihole6api yoyo-migrations python-multipart psycopg2 APScheduler || \
    pip3 install --no-warn-script-location click fastapi uvicorn docker PyYAML psutil lxc paramiko websockets pihole6api yoyo-migrations python-multipart psycopg2 APScheduler || true
else
    echo "pip3 not found, skipping Python dependency installation via pip"
fi
